

import pymysql
import face_recognition
from PyQt5.QtCore import *
import numpy
import configparser
import requests

class InfoThread(QThread):

    Sql_Info_Sin = pyqtSignal(tuple,numpy.ndarray)

    def __init__(self):
        super().__init__()
        
    def SetData(self,face_locations,rgb_small_frame):
        Config = configparser.ConfigParser()
        Config.read("Config.ini")
        self.num_jitters = Config.get("face_encoding", "num_jitters")
        self.tolerance = Config.get("face_encoding", "tolerance")
        
        db_host = Config.get("db", "db_host")
        db_port = Config.get("db", "db_port")
        db_user = Config.get("db", "db_user")
        db_pass = Config.get("db", "db_pass")
        database = Config.get("db", "database")

        self.db = pymysql.connect(host = db_host,port = int(db_port),user = db_user,passwd = db_pass,db = database,charset="utf8" )
        self.cursor = self.db.cursor()
        self.face_locations = face_locations
        self.rgb_small_frame = rgb_small_frame
        self.start()
    def run(self):
        self.face_encodings = face_recognition.face_encodings(self.rgb_small_frame,self.face_locations,num_jitters=int(self.num_jitters))
        #self.Sel_Info_Sql = "SELECT * FROM user ORDER BY SQRT(POW(%g-encoding_0,2)+POW(%g-encoding_1,2)+POW(%g-encoding_2,2)+POW(%g-encoding_3,2)+POW(%g-encoding_4,2)+POW(%g-encoding_5,2)+POW(%g-encoding_6,2)+POW(%g-encoding_7,2)+POW(%g-encoding_8,2)+POW(%g-encoding_9,2)+POW(%g-encoding_10,2)+POW(%g-encoding_11,2)+POW(%g-encoding_12,2)+POW(%g-encoding_13,2)+POW(%g-encoding_14,2)+POW(%g-encoding_15,2)+POW(%g-encoding_16,2)+POW(%g-encoding_17,2)+POW(%g-encoding_18,2)+POW(%g-encoding_19,2)+POW(%g-encoding_20,2)+POW(%g-encoding_21,2)+POW(%g-encoding_22,2)+POW(%g-encoding_23,2)+POW(%g-encoding_24,2)+POW(%g-encoding_25,2)+POW(%g-encoding_26,2)+POW(%g-encoding_27,2)+POW(%g-encoding_28,2)+POW(%g-encoding_29,2)+POW(%g-encoding_30,2)+POW(%g-encoding_31,2)+POW(%g-encoding_32,2)+POW(%g-encoding_33,2)+POW(%g-encoding_34,2)+POW(%g-encoding_35,2)+POW(%g-encoding_36,2)+POW(%g-encoding_37,2)+POW(%g-encoding_38,2)+POW(%g-encoding_39,2)+POW(%g-encoding_40,2)+POW(%g-encoding_41,2)+POW(%g-encoding_42,2)+POW(%g-encoding_43,2)+POW(%g-encoding_44,2)+POW(%g-encoding_45,2)+POW(%g-encoding_46,2)+POW(%g-encoding_47,2)+POW(%g-encoding_48,2)+POW(%g-encoding_49,2)+POW(%g-encoding_50,2)+POW(%g-encoding_51,2)+POW(%g-encoding_52,2)+POW(%g-encoding_53,2)+POW(%g-encoding_54,2)+POW(%g-encoding_55,2)+POW(%g-encoding_56,2)+POW(%g-encoding_57,2)+POW(%g-encoding_58,2)+POW(%g-encoding_59,2)+POW(%g-encoding_60,2)+POW(%g-encoding_61,2)+POW(%g-encoding_62,2)+POW(%g-encoding_63,2)+POW(%g-encoding_64,2)+POW(%g-encoding_65,2)+POW(%g-encoding_66,2)+POW(%g-encoding_67,2)+POW(%g-encoding_68,2)+POW(%g-encoding_69,2)+POW(%g-encoding_70,2)+POW(%g-encoding_71,2)+POW(%g-encoding_72,2)+POW(%g-encoding_73,2)+POW(%g-encoding_74,2)+POW(%g-encoding_75,2)+POW(%g-encoding_76,2)+POW(%g-encoding_77,2)+POW(%g-encoding_78,2)+POW(%g-encoding_79,2)+POW(%g-encoding_80,2)+POW(%g-encoding_81,2)+POW(%g-encoding_82,2)+POW(%g-encoding_83,2)+POW(%g-encoding_84,2)+POW(%g-encoding_85,2)+POW(%g-encoding_86,2)+POW(%g-encoding_87,2)+POW(%g-encoding_88,2)+POW(%g-encoding_89,2)+POW(%g-encoding_90,2)+POW(%g-encoding_91,2)+POW(%g-encoding_92,2)+POW(%g-encoding_93,2)+POW(%g-encoding_94,2)+POW(%g-encoding_95,2)+POW(%g-encoding_96,2)+POW(%g-encoding_97,2)+POW(%g-encoding_98,2)+POW(%g-encoding_99,2)+POW(%g-encoding_100,2)+POW(%g-encoding_101,2)+POW(%g-encoding_102,2)+POW(%g-encoding_103,2)+POW(%g-encoding_104,2)+POW(%g-encoding_105,2)+POW(%g-encoding_106,2)+POW(%g-encoding_107,2)+POW(%g-encoding_108,2)+POW(%g-encoding_109,2)+POW(%g-encoding_110,2)+POW(%g-encoding_111,2)+POW(%g-encoding_112,2)+POW(%g-encoding_113,2)+POW(%g-encoding_114,2)+POW(%g-encoding_115,2)+POW(%g-encoding_116,2)+POW(%g-encoding_117,2)+POW(%g-encoding_118,2)+POW(%g-encoding_119,2)+POW(%g-encoding_120,2)+POW(%g-encoding_121,2)+POW(%g-encoding_122,2)+POW(%g-encoding_123,2)+POW(%g-encoding_124,2)+POW(%g-encoding_125,2)+POW(%g-encoding_126,2)+POW(%g-encoding_127,2)) LIMIT 1"%(self.face_encodings[0][0],self.face_encodings[0][1],self.face_encodings[0][2],self.face_encodings[0][3],self.face_encodings[0][4],self.face_encodings[0][5],self.face_encodings[0][6],self.face_encodings[0][7],self.face_encodings[0][8],self.face_encodings[0][9],self.face_encodings[0][10],self.face_encodings[0][11],self.face_encodings[0][12],self.face_encodings[0][13],self.face_encodings[0][14],self.face_encodings[0][15],self.face_encodings[0][16],self.face_encodings[0][17],self.face_encodings[0][18],self.face_encodings[0][19],self.face_encodings[0][20],self.face_encodings[0][21],self.face_encodings[0][22],self.face_encodings[0][23],self.face_encodings[0][24],self.face_encodings[0][25],self.face_encodings[0][26],self.face_encodings[0][27],self.face_encodings[0][28],self.face_encodings[0][29],self.face_encodings[0][30],self.face_encodings[0][31],self.face_encodings[0][32],self.face_encodings[0][33],self.face_encodings[0][34],self.face_encodings[0][35],self.face_encodings[0][36],self.face_encodings[0][37],self.face_encodings[0][38],self.face_encodings[0][39],self.face_encodings[0][40],self.face_encodings[0][41],self.face_encodings[0][42],self.face_encodings[0][43],self.face_encodings[0][44],self.face_encodings[0][45],self.face_encodings[0][46],self.face_encodings[0][47],self.face_encodings[0][48],self.face_encodings[0][49],self.face_encodings[0][50],self.face_encodings[0][51],self.face_encodings[0][52],self.face_encodings[0][53],self.face_encodings[0][54],self.face_encodings[0][55],self.face_encodings[0][56],self.face_encodings[0][57],self.face_encodings[0][58],self.face_encodings[0][59],self.face_encodings[0][60],self.face_encodings[0][61],self.face_encodings[0][62],self.face_encodings[0][63],self.face_encodings[0][64],self.face_encodings[0][65],self.face_encodings[0][66],self.face_encodings[0][67],self.face_encodings[0][68],self.face_encodings[0][69],self.face_encodings[0][70],self.face_encodings[0][71],self.face_encodings[0][72],self.face_encodings[0][73],self.face_encodings[0][74],self.face_encodings[0][75],self.face_encodings[0][76],self.face_encodings[0][77],self.face_encodings[0][78],self.face_encodings[0][79],self.face_encodings[0][80],self.face_encodings[0][81],self.face_encodings[0][82],self.face_encodings[0][83],self.face_encodings[0][84],self.face_encodings[0][85],self.face_encodings[0][86],self.face_encodings[0][87],self.face_encodings[0][88],self.face_encodings[0][89],self.face_encodings[0][90],self.face_encodings[0][91],self.face_encodings[0][92],self.face_encodings[0][93],self.face_encodings[0][94],self.face_encodings[0][95],self.face_encodings[0][96],self.face_encodings[0][97],self.face_encodings[0][98],self.face_encodings[0][99],self.face_encodings[0][100],self.face_encodings[0][101],self.face_encodings[0][102],self.face_encodings[0][103],self.face_encodings[0][104],self.face_encodings[0][105],self.face_encodings[0][106],self.face_encodings[0][107],self.face_encodings[0][108],self.face_encodings[0][109],self.face_encodings[0][110],self.face_encodings[0][111],self.face_encodings[0][112],self.face_encodings[0][113],self.face_encodings[0][114],self.face_encodings[0][115],self.face_encodings[0][116],self.face_encodings[0][117],self.face_encodings[0][118],self.face_encodings[0][119],self.face_encodings[0][120],self.face_encodings[0][121],self.face_encodings[0][122],self.face_encodings[0][123],self.face_encodings[0][124],self.face_encodings[0][125],self.face_encodings[0][126],self.face_encodings[0][127])
        self.Sel_Info_Sql = "SELECT *,SQRT(POW(%g-encoding_0,2)+POW(%g-encoding_1,2)+POW(%g-encoding_2,2)+POW(%g-encoding_3,2)+POW(%g-encoding_4,2)+POW(%g-encoding_5,2)+POW(%g-encoding_6,2)+POW(%g-encoding_7,2)+POW(%g-encoding_8,2)+POW(%g-encoding_9,2)+POW(%g-encoding_10,2)+POW(%g-encoding_11,2)+POW(%g-encoding_12,2)+POW(%g-encoding_13,2)+POW(%g-encoding_14,2)+POW(%g-encoding_15,2)+POW(%g-encoding_16,2)+POW(%g-encoding_17,2)+POW(%g-encoding_18,2)+POW(%g-encoding_19,2)+POW(%g-encoding_20,2)+POW(%g-encoding_21,2)+POW(%g-encoding_22,2)+POW(%g-encoding_23,2)+POW(%g-encoding_24,2)+POW(%g-encoding_25,2)+POW(%g-encoding_26,2)+POW(%g-encoding_27,2)+POW(%g-encoding_28,2)+POW(%g-encoding_29,2)+POW(%g-encoding_30,2)+POW(%g-encoding_31,2)+POW(%g-encoding_32,2)+POW(%g-encoding_33,2)+POW(%g-encoding_34,2)+POW(%g-encoding_35,2)+POW(%g-encoding_36,2)+POW(%g-encoding_37,2)+POW(%g-encoding_38,2)+POW(%g-encoding_39,2)+POW(%g-encoding_40,2)+POW(%g-encoding_41,2)+POW(%g-encoding_42,2)+POW(%g-encoding_43,2)+POW(%g-encoding_44,2)+POW(%g-encoding_45,2)+POW(%g-encoding_46,2)+POW(%g-encoding_47,2)+POW(%g-encoding_48,2)+POW(%g-encoding_49,2)+POW(%g-encoding_50,2)+POW(%g-encoding_51,2)+POW(%g-encoding_52,2)+POW(%g-encoding_53,2)+POW(%g-encoding_54,2)+POW(%g-encoding_55,2)+POW(%g-encoding_56,2)+POW(%g-encoding_57,2)+POW(%g-encoding_58,2)+POW(%g-encoding_59,2)+POW(%g-encoding_60,2)+POW(%g-encoding_61,2)+POW(%g-encoding_62,2)+POW(%g-encoding_63,2)+POW(%g-encoding_64,2)+POW(%g-encoding_65,2)+POW(%g-encoding_66,2)+POW(%g-encoding_67,2)+POW(%g-encoding_68,2)+POW(%g-encoding_69,2)+POW(%g-encoding_70,2)+POW(%g-encoding_71,2)+POW(%g-encoding_72,2)+POW(%g-encoding_73,2)+POW(%g-encoding_74,2)+POW(%g-encoding_75,2)+POW(%g-encoding_76,2)+POW(%g-encoding_77,2)+POW(%g-encoding_78,2)+POW(%g-encoding_79,2)+POW(%g-encoding_80,2)+POW(%g-encoding_81,2)+POW(%g-encoding_82,2)+POW(%g-encoding_83,2)+POW(%g-encoding_84,2)+POW(%g-encoding_85,2)+POW(%g-encoding_86,2)+POW(%g-encoding_87,2)+POW(%g-encoding_88,2)+POW(%g-encoding_89,2)+POW(%g-encoding_90,2)+POW(%g-encoding_91,2)+POW(%g-encoding_92,2)+POW(%g-encoding_93,2)+POW(%g-encoding_94,2)+POW(%g-encoding_95,2)+POW(%g-encoding_96,2)+POW(%g-encoding_97,2)+POW(%g-encoding_98,2)+POW(%g-encoding_99,2)+POW(%g-encoding_100,2)+POW(%g-encoding_101,2)+POW(%g-encoding_102,2)+POW(%g-encoding_103,2)+POW(%g-encoding_104,2)+POW(%g-encoding_105,2)+POW(%g-encoding_106,2)+POW(%g-encoding_107,2)+POW(%g-encoding_108,2)+POW(%g-encoding_109,2)+POW(%g-encoding_110,2)+POW(%g-encoding_111,2)+POW(%g-encoding_112,2)+POW(%g-encoding_113,2)+POW(%g-encoding_114,2)+POW(%g-encoding_115,2)+POW(%g-encoding_116,2)+POW(%g-encoding_117,2)+POW(%g-encoding_118,2)+POW(%g-encoding_119,2)+POW(%g-encoding_120,2)+POW(%g-encoding_121,2)+POW(%g-encoding_122,2)+POW(%g-encoding_123,2)+POW(%g-encoding_124,2)+POW(%g-encoding_125,2)+POW(%g-encoding_126,2)+POW(%g-encoding_127,2)) as result from face order by result LIMIT 1"%(self.face_encodings[0][0],self.face_encodings[0][1],self.face_encodings[0][2],self.face_encodings[0][3],self.face_encodings[0][4],self.face_encodings[0][5],self.face_encodings[0][6],self.face_encodings[0][7],self.face_encodings[0][8],self.face_encodings[0][9],self.face_encodings[0][10],self.face_encodings[0][11],self.face_encodings[0][12],self.face_encodings[0][13],self.face_encodings[0][14],self.face_encodings[0][15],self.face_encodings[0][16],self.face_encodings[0][17],self.face_encodings[0][18],self.face_encodings[0][19],self.face_encodings[0][20],self.face_encodings[0][21],self.face_encodings[0][22],self.face_encodings[0][23],self.face_encodings[0][24],self.face_encodings[0][25],self.face_encodings[0][26],self.face_encodings[0][27],self.face_encodings[0][28],self.face_encodings[0][29],self.face_encodings[0][30],self.face_encodings[0][31],self.face_encodings[0][32],self.face_encodings[0][33],self.face_encodings[0][34],self.face_encodings[0][35],self.face_encodings[0][36],self.face_encodings[0][37],self.face_encodings[0][38],self.face_encodings[0][39],self.face_encodings[0][40],self.face_encodings[0][41],self.face_encodings[0][42],self.face_encodings[0][43],self.face_encodings[0][44],self.face_encodings[0][45],self.face_encodings[0][46],self.face_encodings[0][47],self.face_encodings[0][48],self.face_encodings[0][49],self.face_encodings[0][50],self.face_encodings[0][51],self.face_encodings[0][52],self.face_encodings[0][53],self.face_encodings[0][54],self.face_encodings[0][55],self.face_encodings[0][56],self.face_encodings[0][57],self.face_encodings[0][58],self.face_encodings[0][59],self.face_encodings[0][60],self.face_encodings[0][61],self.face_encodings[0][62],self.face_encodings[0][63],self.face_encodings[0][64],self.face_encodings[0][65],self.face_encodings[0][66],self.face_encodings[0][67],self.face_encodings[0][68],self.face_encodings[0][69],self.face_encodings[0][70],self.face_encodings[0][71],self.face_encodings[0][72],self.face_encodings[0][73],self.face_encodings[0][74],self.face_encodings[0][75],self.face_encodings[0][76],self.face_encodings[0][77],self.face_encodings[0][78],self.face_encodings[0][79],self.face_encodings[0][80],self.face_encodings[0][81],self.face_encodings[0][82],self.face_encodings[0][83],self.face_encodings[0][84],self.face_encodings[0][85],self.face_encodings[0][86],self.face_encodings[0][87],self.face_encodings[0][88],self.face_encodings[0][89],self.face_encodings[0][90],self.face_encodings[0][91],self.face_encodings[0][92],self.face_encodings[0][93],self.face_encodings[0][94],self.face_encodings[0][95],self.face_encodings[0][96],self.face_encodings[0][97],self.face_encodings[0][98],self.face_encodings[0][99],self.face_encodings[0][100],self.face_encodings[0][101],self.face_encodings[0][102],self.face_encodings[0][103],self.face_encodings[0][104],self.face_encodings[0][105],self.face_encodings[0][106],self.face_encodings[0][107],self.face_encodings[0][108],self.face_encodings[0][109],self.face_encodings[0][110],self.face_encodings[0][111],self.face_encodings[0][112],self.face_encodings[0][113],self.face_encodings[0][114],self.face_encodings[0][115],self.face_encodings[0][116],self.face_encodings[0][117],self.face_encodings[0][118],self.face_encodings[0][119],self.face_encodings[0][120],self.face_encodings[0][121],self.face_encodings[0][122],self.face_encodings[0][123],self.face_encodings[0][124],self.face_encodings[0][125],self.face_encodings[0][126],self.face_encodings[0][127])
        try:
            self.cursor.execute(self.Sel_Info_Sql)
            self.data = self.cursor.fetchone()
            if self.data[132] > float(self.tolerance):
                pass
            else:
                self.Sql_Info_Sin.emit(self.data,self.rgb_small_frame)

                res = requests.get('http://127.0.0.1:8000/show/reqs/?id_card='+self.data[3])
                if res.status_code == 200:
                    pass
                else:
                    print("发送HTTP失败")
            
        except Exception as e:   
            self.db.close()        
            print(e)
        
      
    
            
